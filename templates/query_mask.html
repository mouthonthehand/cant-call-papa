{% extends "base.html" %}
{% block title %}쿼리 마스킹{% endblock %}
{% block content %}
<h2 class="page-title">쿼리 마스킹 / 복원</h2>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{# ── 1단계: 마스킹 신청 ── #}
{% if not step %}
<div class="section">
    <div class="section-title">1단계 &mdash; 원본 쿼리 입력</div>
    <form method="post" action="/query-mask/encrypt">
        <textarea name="original_query" placeholder="마스킹할 SQL 쿼리를 입력하세요..."></textarea>
        <div class="btn-group">
            <button type="submit" class="btn btn-primary">마스킹 실행</button>
        </div>
    </form>
</div>
{% endif %}

{# ── 마스킹 결과 ── #}
{% if step == 'encrypted' %}
<div class="section">
    <div class="section-title">원본 쿼리</div>
    <div class="copy-wrap">
        <textarea readonly>{{ original_query }}</textarea>
    </div>
</div>

<div class="section">
    <div class="section-title">마스킹된 쿼리 (이 쿼리를 외부 LLM에 전달하세요)</div>
    <div class="copy-wrap">
        <textarea readonly id="masked-query">{{ masked_query }}</textarea>
        <button class="copy-btn" onclick="copyText('masked-query')">복사</button>
    </div>
</div>

<div class="section">
    <div class="section-title">치환 매핑</div>
    <table class="mapping-table">
        <thead><tr><th>별칭</th><th>원본</th></tr></thead>
        <tbody>
        {% for alias, original in mapping.items() %}
            <tr><td><code>{{ alias }}</code></td><td><code>{{ original }}</code></td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div class="section">
    <div class="section-title">2단계 &mdash; 외부 LLM 결과 붙여넣기</div>
    <form method="post" action="/query-mask/decrypt">
        <input type="hidden" name="history_id" value="{{ history_id }}">
        <textarea name="modified_query" placeholder="외부 LLM이 개선한 마스킹 쿼리를 여기에 붙여넣으세요..."></textarea>
        <div class="btn-group">
            <button type="submit" class="btn btn-success">원본으로 복원</button>
        </div>
    </form>
</div>
{% endif %}

{# ── 복원 결과 ── #}
{% if step == 'decrypted' %}
<div class="section">
    <div class="section-title">외부 LLM 수정 쿼리 (마스킹 상태)</div>
    <textarea readonly>{{ modified_query }}</textarea>
</div>

<div class="section">
    <div class="section-title">복원된 최종 쿼리</div>
    <div class="copy-wrap">
        <textarea readonly id="restored-query">{{ restored_query }}</textarea>
        <button class="copy-btn" onclick="copyText('restored-query')">복사</button>
    </div>
    <div class="btn-group">
        <a href="/query-mask" class="btn btn-primary">새 쿼리 마스킹</a>
        <a href="/query-mask/history/{{ history_id }}" class="btn btn-secondary">이력 상세보기</a>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
function copyText(id) {
    const el = document.getElementById(id);
    el.select();
    document.execCommand('copy');
    const btn = el.parentElement.querySelector('.copy-btn');
    btn.textContent = '복사됨!';
    setTimeout(() => btn.textContent = '복사', 1500);
}
</script>
{% endblock %}
